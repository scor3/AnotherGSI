name: Build LineageOS GSI with custom APKs

on:
  workflow_dispatch:
    inputs:
      android_version:
        description: 'Android version (14 or 15)'
        required: true
        default: '15'
        type: choice
        options:
          - '14'
          - '15'
      arch:
        description: 'Architecture (arm64 only for GSI)'
        required: true
        default: 'arm64'
        type: choice
        options:
          - arm64

env:
  BRANCH_15: lineage-22.2
  BRANCH_14: lineage-21.0

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      - name: Checkout my repository (with APKs)
        uses: actions/checkout@v4
        with:
          path: vendor/myprebuilts

      - name: Prepare build environment
        run: |
          sudo apt update
          sudo apt install -y openjdk-17-jdk git-core gnupg flex bison build-essential \
            zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 libncurses5 \
            lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev \
            libxml2-utils xsltproc unzip fontconfig python3

      - name: Install repo
        run: |
          mkdir -p $HOME/.bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > $HOME/.bin/repo
          chmod a+x $HOME/.bin/repo
          echo "$HOME/.bin" >> $GITHUB_PATH

      - name: Set branch based on input
        id: set_branch
        run: |
          if [ "${{ github.event.inputs.android_version }}" = "15" ]; then
            echo "branch=${{ env.BRANCH_15 }}" >> $GITHUB_OUTPUT
          else
            echo "branch=${{ env.BRANCH_14 }}" >> $GITHUB_OUTPUT
          fi

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-gsi-${{ steps.set_branch.outputs.branch }}-${{ github.run_id }}
          restore-keys: |
            ccache-gsi-${{ steps.set_branch.outputs.branch }}-

      - name: Initialize LineageOS source (shallow)
        run: |
          mkdir -p $HOME/android/lineage
          cd $HOME/android/lineage
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          repo init -u https://github.com/LineageOS/android.git -b ${{ steps.set_branch.outputs.branch }} --depth=1 --no-clone-bundle

      - name: ðŸ”¥ NUCLEAR SYNC (RUST PROBLEM FIXED)
        run: |
          cd $HOME/android/lineage
          echo "ðŸ”¥ Current directory: $(pwd)"
          echo "ðŸ”¥ Disk space before sync:"
          df -h
          
          # ÐŸÐ¾Ð»Ð½Ð°Ñ Ð·Ð°Ñ‡Ð¸ÑÑ‚ÐºÐ° rust-Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
          echo "ðŸ”¥ Removing problematic rust project from .repo and worktree..."
          rm -rf .repo/projects/prebuilts/rust.git || true
          rm -rf prebuilts/rust || true
          
          # Ð§Ð¸ÑÑ‚Ð¸Ð¼ Ð¼Ð°Ð½Ð¸Ñ„ÐµÑÑ‚Ñ‹ Ð¾Ñ‚ ÑƒÐ¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ð¹ rust
          echo "ðŸ”¥ Cleaning rust references from manifests..."
          find .repo/manifests -name "*.xml" -exec sed -i '/rust/d' {} \; 2>/dev/null || true
          
          # Ð¡Ð¸Ð½Ðº Ñ ÐºÑƒÑ‡ÐµÐ¹ Ñ„Ð»Ð°Ð³Ð¾Ð² Ð´Ð»Ñ Ð½Ð°Ð´ÐµÐ¶Ð½Ð¾ÑÑ‚Ð¸
          echo "ðŸ”¥ Running repo sync with maximum force..."
          repo sync -c -j4 --no-tags --no-clone-bundle --force-sync --force-remove-dirty --retry-fetches=5 || true
          
          # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ ÑÐ¸Ð½ÐºÐ½ÑƒÑ‚ÑŒ rust Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾ (ÐµÑÐ»Ð¸ Ð²Ñ‹Ð¶Ð¸Ð»)
          echo "ðŸ”¥ Attempting to sync rust project specifically..."
          repo sync platform/prebuilts/rust --force-sync || true
          
          # Ð•ÑÐ»Ð¸ Ð²ÑÑ‘ ÐµÑ‰Ñ‘ Ð½Ðµ ÑÐ´Ð¾Ñ…Ð»Ð¾, ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð·Ð°Ð³Ð»ÑƒÑˆÐºÑƒ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð´Ð°Ð»ÑŒÑˆÐµ Ð½Ðµ Ð¿Ð°Ð´Ð°Ñ‚ÑŒ
          echo "ðŸ”¥ Ensuring rust directory exists (as dummy)..."
          mkdir -p prebuilts/rust
          echo "# Dummy rust project" > prebuilts/rust/Android.bp
          
          echo "ðŸ”¥ Disk space after sync:"
          df -h
          echo "âœ… Sync phase completed (with or without rust)"

      - name: Set up build environment
        run: |
          cd $HOME/android/lineage
          source build/envsetup.sh
          lunch lineage_${{ github.event.inputs.arch }}-userdebug

      - name: Build system image
        run: |
          cd $HOME/android/lineage
          make systemimage -j$(nproc)

      - name: Prepare output
        run: |
          cd $HOME/android/lineage/out/target/product/generic_${{ github.event.inputs.arch }}
          if [ -f system.img ]; then
            cp system.img lineage-gsi-${{ github.event.inputs.android_version }}-${{ github.run_number }}.img
          fi

      - name: Upload GSI image
        uses: actions/upload-artifact@v4
        with:
          name: lineage-gsi-${{ github.event.inputs.android_version }}
          path: $HOME/android/lineage/out/target/product/generic_${{ github.event.inputs.arch }}/lineage-gsi-*.img
          retention-days: 30
