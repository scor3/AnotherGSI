name: Build LineageOS GSI with custom APKs

on:
  workflow_dispatch:
    inputs:
      android_version:
        description: 'Android version (14 or 15)'
        required: true
        default: '15'
        type: choice
        options:
          - '14'
          - '15'
      arch:
        description: 'Architecture (arm64 only for GSI)'
        required: true
        default: 'arm64'
        type: choice
        options:
          - arm64

env:
  BRANCH_15: lineage-22.2
  BRANCH_14: lineage-21.0

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      - name: Checkout my repository (with APKs)
        uses: actions/checkout@v4
        with:
          path: vendor/myprebuilts

      - name: Prepare build environment
        run: |
          sudo apt update
          sudo apt install -y openjdk-17-jdk git-core gnupg flex bison build-essential \
            zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 libncurses5 \
            lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev \
            libxml2-utils xsltproc unzip fontconfig python3

      - name: Install repo
        run: |
          mkdir -p $HOME/.bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > $HOME/.bin/repo
          chmod a+x $HOME/.bin/repo
          echo "$HOME/.bin" >> $GITHUB_PATH

      - name: Set branch based on input
        id: set_branch
        run: |
          if [ "${{ github.event.inputs.android_version }}" = "15" ]; then
            echo "branch=${{ env.BRANCH_15 }}" >> $GITHUB_OUTPUT
          else
            echo "branch=${{ env.BRANCH_14 }}" >> $GITHUB_OUTPUT
          fi

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-gsi-${{ steps.set_branch.outputs.branch }}-${{ github.run_id }}
          restore-keys: |
            ccache-gsi-${{ steps.set_branch.outputs.branch }}-

      - name: Initialize LineageOS source
        run: |
          mkdir -p $HOME/android/lineage
          cd $HOME/android/lineage
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          repo init -u https://github.com/LineageOS/android.git -b ${{ steps.set_branch.outputs.branch }} --depth=1

      - name: Sync source (with force and retries)
        run: |
          cd $HOME/android/lineage
          echo "Current directory: $(pwd)"
          echo "Disk space before sync:"
          df -h
          
          # Удаляем только проблемный rust, если он есть (но не трогаем манифесты)
          rm -rf prebuilts/rust || true
          
          # Синхронизируем всё с флагами надежности
          echo "Running repo sync..."
          repo sync -c -j4 --no-tags --force-sync --retry-fetches=5
          
          echo "Disk space after sync:"
          df -h
          
          # Проверяем, что нужные файлы на месте
          echo "Checking for build/envsetup.sh..."
          if [ ! -f build/envsetup.sh ]; then
            echo "build/envsetup.sh not found! Syncing build/make specifically..."
            repo sync build/make --force-sync
          fi
          
          ls -la build/ || echo "build/ directory missing"

      - name: Set up build environment
        run: |
          cd $HOME/android/lineage
          if [ ! -f build/envsetup.sh ]; then
            echo "ERROR: build/envsetup.sh still missing!"
            exit 1
          fi
          source build/envsetup.sh
          lunch lineage_${{ github.event.inputs.arch }}-userdebug

      - name: Build system image
        run: |
          cd $HOME/android/lineage
          make systemimage -j$(nproc)

      - name: Prepare output
        run: |
          cd $HOME/android/lineage/out/target/product/generic_${{ github.event.inputs.arch }}
          if [ -f system.img ]; then
            cp system.img lineage-gsi-${{ github.event.inputs.android_version }}-${{ github.run_number }}.img
          fi

      - name: Upload GSI image
        uses: actions/upload-artifact@v4
        with:
          name: lineage-gsi-${{ github.event.inputs.android_version }}
          path: $HOME/android/lineage/out/target/product/generic_${{ github.event.inputs.arch }}/lineage-gsi-*.img
          retention-days: 30
